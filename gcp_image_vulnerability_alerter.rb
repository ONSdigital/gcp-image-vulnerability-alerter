#!/usr/bin/env ruby
# frozen_string_literal: true

require 'google/cloud/container_analysis'
require 'logger'
require 'rest-client'
require 'time'

require_relative 'package_issue'

# Class that posts alerts to a specified Slack channel when Docker images with high or critical security vulnerabilities
# as identified by the Google Container Analysis API are found in the formal GCR repositories.
class GCPContainerAnalysis
  SEVERITIES     = %i[HIGH CRITICAL].freeze
  THREE_SECONDS  = 3

  def initialize
    environment_check
    @logger = Logger.new($stdout)
    @client = Google::Cloud::ContainerAnalysis.new
  end

  def run
    todays_vulnerability_occurrences.each do |occurrence|
      package_issues = []
      effective_severity = occurrence.vulnerability.effective_severity
      next unless SEVERITIES.include?(effective_severity)

      occurrence.vulnerability.package_issue.each do |issue|
        package_issues << PackageIssue.new(effective_severity, occurrence.vulnerability.short_description, issue.affected_package)
      end
      occurrence.vulnerability.related_urls.each do |related_url|
        package_issues.each { |package_issue| package_issue.related_url = related_url.url }
      end

      post_slack_message(occurrence.resource_uri, package_issues)
    end
  end

  private

  def environment_check
    raise 'Missing CONTAINER_ANALYSIS_CREDENTIALS environment variable' unless ENV['CONTAINER_ANALYSIS_CREDENTIALS']
    raise 'Missing CONTAINER_ANALYSIS_PROJECT environment variable' unless ENV['CONTAINER_ANALYSIS_PROJECT']
    raise 'Missing GCP_VULNERABILITY_ALERTER_SLACK_CHANNEL environment variable' unless ENV['GCP_VULNERABILITY_ALERTER_SLACK_CHANNEL']
    raise 'Missing SLACK_WEBHOOK environment variable' unless ENV['SLACK_WEBHOOK']
  end

  # See https://stackoverflow.com/a/42001209
  def occurrence_time_to_time(occurrence)
    epoch_ms = occurrence.create_time.nanos / 10**6
    Time.at(occurrence.create_time.seconds, epoch_ms)
  end

  def post_slack_message(resource_uri, package_issues)
    sleep THREE_SECONDS # Avoid Slack's rate limits.
    attachments = []
    package_issues.each { |package_issue| attachments << package_issue.to_slack_attachment }
    vulnerability_noun = package_issues.length > 1 ? 'Vulnerabilities' : 'Vulnerability'
    payload = {
      'channel': ENV['GCP_VULNERABILITY_ALERTER_SLACK_CHANNEL'],
      'icon_emoji': ':gcp:',
      'username': "GCP Image Vulnerability Alerter - #{ENV['CONTAINER_ANALYSIS_PROJECT']}",
      'text': "#{vulnerability_noun} found in image #{resource_uri}:",
      'attachments': attachments
    }.to_json.encode('UTF-8')
    headers = { 'Content-Type': 'application/json' }
    begin
      RestClient.post(ENV['SLACK_WEBHOOK'], payload, headers)
    rescue RestClient::ExceptionWithResponse => e
      @logger.error("Error posting to Slack: HTTP #{e.response.code} #{e.response}")
    end
  end

  def today?(day)
    day >= Time.now.day
  end

  def todays_vulnerability_occurrences
    grafeas_client = @client.grafeas_client
    parent = Grafeas::V1::GrafeasClient.project_path(ENV['CONTAINER_ANALYSIS_PROJECT'])
    occurrences = []
    grafeas_client.list_occurrences(parent).each do |occurrence|
      occurrence_time = occurrence_time_to_time(occurrence)
      occurrences << occurrence if today?(occurrence_time.day) && occurrence.kind == :VULNERABILITY
    end
    occurrences
  end
end

GCPContainerAnalysis.new.run
